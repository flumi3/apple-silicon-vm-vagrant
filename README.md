# Kali Security VM for Apple Silicon

Reproducible security-focused VM for Macs with Apple Silicon (M1/M2/M3), deployed with Vagrant and UTM.

This project provides a pre-configured Debian-based VM with optional Kali Linux security tools. Since Kali Linux is not
available as a native ARM64 Vagrant box, this setup uses a Debian Bookworm base image and provisions it with security
tools from the Kali repositories.

> **Note**: This setup is specifically designed for Apple Silicon Macs using UTM. For Intel Macs or other platforms, use
> the [official Kali Linux Vagrant boxes](https://www.kali.org/get-kali/#kali-virtual-machines).

## Features

- ðŸš€ **Quick Setup**: Interactive CLI wizard (`./setup.sh`) configures everything
- âš¡ **Flexible Provisioning**: Choose minimal (~10 min) or full security toolkit (~45 min)
- ðŸ”’ **Corporate Proxy Support**: Auto-detects and installs any CA certificates in `config/`
- ðŸ› ï¸ **Security Tools**: Nmap, Metasploit, Burp Suite, and more (full mode)
- ðŸ³ **Development Ready**: Docker, Python, Node.js pre-installed
- ðŸ’» **Customizable**: Timezone, keyboard, locale configuration
- ðŸ“ **Persistent Storage**: Shared folders for projects and data

## Quick Start

### Prerequisites

```bash
# Install UTM
brew install --cask utm

# Install Vagrant
brew install --cask vagrant

# Install the UTM plugin for Vagrant
vagrant plugin install vagrant_utm
```

### Setup

```bash
# Clone the repository
git clone https://github.com/flumi3/kali-vm-vagrant.git
cd kali-vm-vagrant

# Run the setup wizard
./setup.sh

# Start the VM
vagrant up
```

The setup wizard will guide you through:

- VM resources (memory, CPUs)
- Locale settings (timezone, keyboard)
- Provisioning mode (minimal or full)
- Corporate proxy configuration (optional)

### Connect

```bash
vagrant ssh
```

## Provisioning Modes

### Minimal Mode (Default)

Fast provisioning (~10 minutes) with essential tools:

- curl, wget, git, vim, zsh, htop
- Docker & Docker Compose
- OpenVPN, tmux
- Python 3 with pip/pipx
- Node.js with npm

### Full Mode

Complete security toolkit (~45 minutes), includes everything in minimal plus:

- **Kali Tools**: nmap, sqlmap, john, hydra, wireshark, aircrack-ng, burpsuite, metasploit
- **Python Security Packages**: impacket, bloodhound, crackmapexec, scapy, pwntools
- **Wordlists**: rockyou.txt, SecLists

To use full mode:

```bash
# During setup, select "full" when prompted
./setup.sh

# Or set the environment variable
export PROVISIONING_MODE=full
vagrant up

# Or upgrade an existing minimal VM
PROVISIONING_MODE=full vagrant provision
```

## Configuration

### Environment Variables

You can configure the VM by setting environment variables or using the `.env` file generated by `./setup.sh`:

| Variable            | Default         | Description         |
| ------------------- | --------------- | ------------------- |
| `VM_NAME`           | `security-vm`   | VM display name     |
| `VM_MEMORY`         | `4096`          | RAM in MB           |
| `VM_CPUS`           | `4`             | CPU cores           |
| `USER_TIMEZONE`     | `Europe/Berlin` | System timezone     |
| `USER_KEYBOARD`     | `de`            | Keyboard layout     |
| `USER_LOCALE`       | `en_US.UTF-8`   | System locale       |
| `PROVISIONING_MODE` | `minimal`       | `minimal` or `full` |
| `HTTP_PROXY`        |                 | HTTP proxy URL      |
| `HTTPS_PROXY`       |                 | HTTPS proxy URL     |

### Corporate Proxy / SSL Inspection

If you're behind a corporate proxy that performs SSL inspection (e.g., ZScaler, Netskope, Palo Alto), you'll need to add
your company's root CA certificate:

1. Export your company's root certificate as a `.crt` file (PEM format)
2. Place it in the `config/` directory:

   ```bash
   cp /path/to/your-company-ca.crt config/
   ```

3. The certificate will be automatically detected and installed during provisioning

Multiple certificates are supported - just place all `.crt` files in the `config/` directory.

### Directory Structure

```
kali-vm-vagrant/
â”œâ”€â”€ Vagrantfile              # Vagrant configuration
â”œâ”€â”€ setup.sh                 # Interactive setup wizard
â”œâ”€â”€ .env                     # Generated configuration (gitignored)
â”œâ”€â”€ config/                  # Configuration files
â”‚   â”œâ”€â”€ *.crt               # Corporate CA certificates (auto-detected)
â”‚   â””â”€â”€ kali-archive-keyring.gpg
â”œâ”€â”€ provision/               # Provisioning scripts
â”‚   â”œâ”€â”€ configure-proxy.sh   # Certificate & proxy setup
â”‚   â”œâ”€â”€ install-packages-minimal.sh
â”‚   â”œâ”€â”€ install-packages-full.sh
â”‚   â”œâ”€â”€ system-config.sh     # Timezone, keyboard, locale
â”‚   â”œâ”€â”€ user-config.sh       # User environment
â”‚   â””â”€â”€ final-provision.sh   # Final configuration
â”œâ”€â”€ projects/                # Your projects (synced)
â””â”€â”€ shared/                  # Shared files (synced)
```

## Vagrant Commands

```bash
# Start the VM
vagrant up

# Connect via SSH
vagrant ssh

# Stop the VM
vagrant halt

# Restart the VM
vagrant reload

# Delete the VM
vagrant destroy

# Re-run provisioning
vagrant provision

# Run specific provisioners
vagrant provision --provision-with configure-proxy
vagrant provision --provision-with install-packages-minimal
vagrant provision --provision-with user-config
```

## Network & Port Forwarding

The following ports are forwarded from the VM to your host:

| Guest Port | Host Port | Purpose                     |
| ---------- | --------- | --------------------------- |
| 8080       | 8080      | Burp Suite / ZAP Proxy      |
| 4444       | 4444      | Metasploit / Reverse shells |
| 8000       | 8000      | HTTP server                 |

## Troubleshooting

### SSL/Certificate Errors

If you see SSL certificate verification errors during provisioning:

1. **Corporate Proxy**: Place your company's root CA certificate in `config/*.crt`
2. **Vagrant SSL Issues**: If Vagrant itself has SSL issues, append your certificate to Vagrant's CA bundle:

   ```bash
   # Find Vagrant's cacert.pem
   # macOS: /opt/vagrant/embedded/cacert.pem

   # Append your certificate
   cat /path/to/your-ca.crt >> /opt/vagrant/embedded/cacert.pem
   ```

### Kali Repository Blocked

Corporate networks may block access to Kali repositories. The provisioning script:

1. Tries multiple university mirrors first
2. Falls back to the bundled GPG keyring if downloads fail

If all mirrors are blocked, ask your IT team to whitelist one of:

- `ftp.halifax.rwth-aachen.de`
- `mirror.karneval.cz`
- `ftp.acc.umu.se`

### UTM Plugin Issues

If you encounter issues with the vagrant_utm plugin:

```bash
# Reinstall the plugin
vagrant plugin uninstall vagrant_utm
vagrant plugin install vagrant_utm

# Check plugin version
vagrant plugin list
```

## License

MIT
